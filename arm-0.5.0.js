var CSkeleton=Class({construct:function(a){if(isSet(a))this.center=isTObject(a.center)?a.center:{x:this.nativeSegments[0].x0,y:this.nativeSegments[0].y0},this.rotateCenter=isTObject(a.rotateCenter)?a.rotateCenter:{x:this.nativeSegments[0].x0,y:this.nativeSegments[0].y0},this.angel=isTNumberPos(a.angel)?a.angel:0,this._init(TArray(a.segments)),this._translateTo(this.center),this._rotate(this.angel),this._setFunction();else throw Error("CSkeleton: constructor(), Error");},vars:{segments:[],nativeSegments:[],
functions:[],center:{x:0,y:0},rotateCenter:{x:0,y:0}},methods:{_init:function(a){var b=[],c;for(c in a){var d=a;b.push({p0:[d[c].x0,d[c].y0,1],p1:[d[c].x1,d[c].y1,1]})}this.segments=this.nativeSegments=b},_setFunction:function(){this.functions=[];for(var a in this._nativeSegments){var b=this._nativeSegments;if(isTNumberPos(b[a].p0[0])&&isTNumberPos(b[a].p0[1])&&isTNumberPos(b[a].p1[0])&&isTNumberPos(b[a].p1[1])){var c=b[a].p0[0],d=b[a].p0[1],e=b[a].p1[0],b=b[a].p1[1],b=0!=e-c?(b-d)/(e-c):(b-d)/0.001,
d=d-b*c,f={};f.k=b;f.b=d;f.x0=c;f.x1=e;this.functions.push(f)}}},_translateTo:function(a){var a=TPoint(a),b=[],c;for(c in this.nativeSegments){var d=this.nativeSegments[c];b.push({p0:[d.p0[0]+a.x,d.p0[1]+a.y,1],p1:[d.p1[0]+a.x,d.p1[1]+a.y,1]})}this.segments=b;this.center={x:a.x,y:a.y}},_rotate:function(){}}});var CSuperObj=Class({construct:function(){},vars:{context:null,x:0,y:0,globalCenter:{x:0,y:0},localCenter:{x:0,y:0},center:{x:0,y:0},angel:0,globalAngel:0,localAngel:0,rotateCenter:{x:0,y:0},localRotateCenter:{x:0,y:0}},methods:{clone:function(){var a=[],b=function(c){if(null==c||"object"!=typeof c)return c;for(var d in a)if(a[d]==c)return c;a.push(c);if("function"==typeof c.constructor){d=new c.constructor;for(var e in c)if(c.hasOwnProperty(e))if("_context"==e)d[e]=c[e];else{var f=c.__lookupGetter__(e),
g=c.__lookupSetter__(e);f||g?(f&&d.prototype.__defineGetter__(e,f),g&&d.prototype.__defineSetter__(e,g)):d[e]=b(c[e])}}else return c;delete d.name;return d};return b(this)}}});var CObject=Class({base:CSuperObj,construct:function(a){if(isSet(a)){isTPoint(a.center)&&(this.x=a.center.x,this.y=a.center.y,this.globalCenter={x:a.center.x,y:a.center.y},this.localCenter={x:a.center.x,y:a.center.y});isTNumber(a.x)&&(this.x=a.x);isTNumber(a.y)&&(this.y=a.y);isTPoint(a.rotateCenter)&&(this.rotateCenter={x:a.rotateCenter.x,y:a.rotateCenter.y},this.localRotateCenter={x:a.rotateCenter.x,y:a.rotateCenter.y});isTNumberPos(a.angel)&&(this.angel=this.localAngel=this.globalAngel=a.angel);
if(isTArray(a.collection))for(var b in a.collection)(isTArmShape(a.collection[b])||isTArmObject(a.collection[b]))&&this.add(a.collection[b]);isTArray(a.skeleton);if(isTObject(a.vars))for(var c in a.vars){var d=a.vars;this[c]=d[c];var e=function(){var a=c;switch(type(d[c])){case "String":return function(){return TString(this[a])};case "Number":return function(){return TNumber(this[a])};case "Boolean":return function(){return TBool(this[a])};case "Array":return function(){return TArray(this[a])};case "Date":return function(){return TDate(this[a])};
default:return function(){return this[a]}}}(c);(function(){var a=c;switch(type(d[c])){case "String":return function(b){this[a]=TString(b)};case "Number":return function(b){this[a]=TNumber(b)};case "Boolean":return function(b){this[a]=TBool(b)};case "Array":return function(b){this[a]=TArray(b)};case "Date":return function(b){this[a]=TDate(b)};default:return function(b){this[a]=b}}})(c)(d[c]);e(d[c])}isTFunc(a.begin)&&(this.begin=a.begin);isTFunc(a.update)&&(this.update=a.update);if(isTObject(a.events))for(b in a.events)"function"==
typeof a.events[b]&&(this[b]=a.events[b])}},vars:{collection:[],skeleton:{},type:"object"},methods:{add:function(a){if(isTArmObject(a)||isTArmShape(a))a.context=this.context,a.x+=this.x,a.Y+=this.y,a.globalCenter.x=a.localCenter.x+this.globalCenter.x,a.globalCenter.y=a.localCenter.y+this.globalCenter.y,a.rotateCenter={x:this.rotateCenter.x,y:this.rotateCenter.y},a.localRotateCenter={x:this.rotateCenter.x,y:this.rotateCenter.y},a.globalAngel=a.localAngel+this.globalAngel,a.angel=a.globalAngel,this.collection.push(a),
isSet(a.name)&&(this[a.name]=a);else throw Error("Object: add() -> Incorrect object!");},remove:function(a){try{if(isTArmObject(a)||isTArmShape(a))for(var b in this.collection)this.collection[b]==a&&delete this.collection[b];else throw Error("Object: remove(O) -> O is not shape or object!");}catch(c){console.log(c)}},set context(a){this._context=a;for(var b in this.collection)this.collection[b].context=a},get context(){return this._context},_begin:function(a){"function"==typeof this.begin&&this.begin.call(this,
a);for(var b in this.collection){var c=this.collection[b];"function"==typeof c.begin&&c!=this&&c.begin.call(c,a)}},_clean:function(a){for(var b in this.collection){var c=this.collection[b];c._clean.call(c,a)}},_updateSkeleton:function(){for(var a in this.collection){var b=this.collection[a];this.globalCenter={x:this.x,y:this.y};this.globalAngel=this.angel;this.rotateCenter={x:this.localRotateCenter.x+this.x,y:this.localRotateCenter.y+this.y};b.x=this.x+b.localCenter.x;b.y=this.y+b.localCenter.y;b.globalCenter=
{x:b.x,y:b.y};b.rotateCenter=this.rotateCenter;b.globalAngel=this.angel+b.localAngel;b.angel=b.globalAngel}},_update:function(a){isTFunc(this.update)&&this.update.call(this,a);this._updateSkeleton.call(this,a);for(var b in this.collection){var c=this.collection[b];c.update&&c.update.call(c,a)}},_draw:function(a){for(var b in this.collection){var c=this.collection[b];c._draw.call(c,a)}},_info:function(a){a.context.beginPath();a.context.moveTo(this.rotateCenter.x,this.rotateCenter.y);a.context.arc(this.rotateCenter.x,
this.rotateCenter.y,2,2*Math.PI,!1);this.context.stroke();this.context.fillStyle="#a00";this.context.fill();a.context.closePath();a.context.beginPath();a.context.moveTo(this.globalCenter.x,this.globalCenter.y);a.context.arc(this.globalCenter.x,this.globalCenter.y,2,2*Math.PI,!1);this.context.stroke();this.context.fillStyle="#abc";this.context.fill();a.context.closePath();for(var b in this.collection)a=this.collection[b],"function"==typeof a._info&&a._info.call(a,this)},_event:function(a){for(var b in this.collection)"function"==
typeof this.collection[b]._event&&this.collection[b]._event.call(this.collection[b],a)},_onkeydown:function(a,b){"function"==typeof this.onkeydown&&this.onkeydown.call(this,a,b);for(var c in this.collection){var d=this.collection[c];"function"==typeof d._onkeydown&&(d=this.collection[c],d._onkeydown.call(d,a,b))}}}});CShape=Class({base:CSuperObj,construct:function(){},vars:{stroke:"black",lineWidth:1,shapeType:"shape",type:"shape"},methods:{}});var CRect=Class({base:CShape,construct:function(a){"undefined"!=typeof a&&(this.x=a.x||this.x,this.y=a.y||this.y,this.angel=a.angel||this.angel,this.stroke=a.stroke||this.stroke,this.fill=a.fill||this.fill,this.context=a.context||this.context,this.name=a.name||this.name,"undefined"!=typeof a.width&&0<a.width&&(this.width=a.width),"undefined"!=typeof a.height&&0<a.height&&(this.height=a.height),"undefined"!=typeof a.lineWidth&&0<a.lineWidth&&(this.lineWidth=a.lineWidth))},vars:{width:100,height:100,
fill:"gray",shapeType:"rect"},methods:{_clean:function(){},_draw:function(){this.context.save();this.context.translate(this.x+this.width/2,this.y+this.height/2);this.context.rotate(this.angel*Math.PI/180);this.context.translate(-(this.x+this.width/2),-(this.y+this.height/2));this.context.beginPath();this.context.rect(this.x,this.y,this.width,this.height);this.context.closePath();this.context.fillStyle=this.fill;this.context.lineWidth=this.lineWidth;this.context.strokeStyle=this.stroke;this.context.fill();
this.context.stroke();this.context.restore()}}});var CCircle=Class({base:CShape,construct:function(a){"undefined"!=typeof a&&("number"==typeof a.x&&(this.x=a.x),"number"==typeof a.y&&(this.y=a.y),"string"==typeof a.stroke&&(this.x=a.stroke),"string"==typeof a.fill&&(this.fill=a.fill),"undefined"!=typeof a.name&&(this.name=a.name),"undefined"!=typeof a.context&&(this.x=a.stroke),"undefined"!=typeof a.radius&&0<a.radius&&(this.radius=a.radius),"undefined"!=typeof a.lineWidth&&0<a.lineWidth&&(this.lineWidth=a.lineWidth))},vars:{radius:100,fill:"gray",
shapeType:"circle"},methods:{_clean:function(){this.context.clearRect(this.x-this.radius-this.lineWidth,this.y-this.radius-this.lineWidth,this.x+this.radius+this.lineWidth,this.y+this.radius+this.lineWidth)},_draw:function(){this.context.beginPath();this.context.arc(this.x,this.y,this.radius,0,2*Math.PI,!1);this.context.closePath();this.context.fillStyle=this.fill;this.context.fill();this.context.lineWidth=this.lineWidth;this.context.strokeStyle=this.stroke;this.context.stroke()}}});CImage=Class({base:CShape,construct:function(a){if("undefined"!=typeof a){this.x=a.x||this.x;this.y=a.y||this.y;this.localCenter={x:this.x,y:this.y};this.globalCenter={x:this.x,y:this.y};this.globalAngel=this.localAngel=a.angel||this.localAngel;this.rotateCenter=a.rotateCenter||this.rotateCenter;this.image=a.image||this.image;if(isSet(a.src)&&isTString(a.src)){var b=a.src,c=this,d=new Image;d.src=b;d.onload=function(){c.image=d;c.onload=!0}}this.context=a.context||this.context;this.name=a.name||this.name;
this.width=a.width;this.height=a.height}},vars:{width:100,height:100,image:new Image,onload:!1,shapeType:"image"},methods:{_clean:function(){},_draw:function(){!0==this.onload&&(this.context.save(),this.context.translate(this.rotateCenter.x,this.rotateCenter.y),this.context.rotate(this.globalAngel*Math.PI/180),this.context.translate(-this.rotateCenter.x,-this.rotateCenter.y),this.context.drawImage(this.image,this.x,this.y,this.width,this.height),this.context.restore())}}});var CLine=Class({base:CShape,construct:function(a){"undefined"!=typeof a&&(this.x0=a.x0||this.x,this.y0=a.y0||this.y,this.x1=a.x1||this.x+100,this.y1=a.y1||this.y+100,this.stroke=a.stroke||this.stroke,this.context=a.context||this.context,this.name=a.name||this.name,"undefined"!=typeof a.lineWidth&&0<a.lineWidth&&(this.lineWidth=a.lineWidth))},vars:{x0:10,y0:10,x1:100,y1:100,shapeType:"line"},methods:{_clean:function(){},_draw:function(){this.context.beginPath();this.context.moveTo(this.x0,this.y0);
this.context.lineTo(this.x1,this.y1);this.context.closePath();this.context.lineWidth=this.lineWidth;this.context.strokeStyle=this.stroke;this.context.stroke()}}});var CStage=Class({construct:function(a){this.fps=a.fps||this.fps;this.width=a.width||this.width;this.height=a.height||this.height;if(a.container){var a=document.getElementById(a.container),b=document.createElement("canvas");b.width=this.width;b.height=this.height;b.style.id="2k2nd";a.appendChild(b);this.context=b.getContext("2d")}else throw Error("The container is not found! Choose right name of container, please!");this._init()},vars:{collection:[],context:{},events:{},fps:10,intervalId:null,finfo:!1,
width:500,height:500},methods:{add:function(a){if("object"==typeof a&&("shape"==a.type||"object"==a.type))a.context=this.context,this.collection.push(a);else throw Error("Stage: add(O) -> O is not shape or object!");},remove:function(a){if("object"==typeof a&&("shape"==a.type||"object"==a.type))for(var b in this.collection)this.collection[b]==a&&delete this.collection[b];else throw Error("Stage: remove(O) -> O is not shape or object!");},_init:function(){var a=this;document.onkeydown=function(b){a._onkeydown(b)}},
_begin:function(a){for(var b in this.collection){var c=this.collection[b];"function"==typeof c._begin&&c._begin.call(c,a)}},_clean:function(a){this.context.clearRect(0,0,a.width,a.height)},_updateSkeleton:function(a){for(var b in this.collection){var c=this.collection[b];"function"==typeof c._updateSkeleton&&c._updateSkeleton.call(c,a)}},_update:function(a){for(var b in this.collection){var c=this.collection[b];"function"==typeof c._update&&c._update.call(c,a)}},_draw:function(a){for(var b in this.collection){var c=
this.collection[b];"function"==typeof c._draw&&c._draw.call(c,a)}},_info:function(){if(!0==this.finfo)for(var a in this.collection){var b=this.collection[a];"function"==typeof b._info&&b._info.call(b,this)}},_event:function(a){for(var b in this.collection){var c=this.collection[b];"function"==typeof c._event&&c._event.call(c,a)}},_onkeydown:function(a){for(var b in this.collection){var c=this.collection[b];"function"==typeof c._onkeydown&&c._onkeydown.call(c,a,this)}},_process:function(){stats.begin();
this._clean.call(this,this);this._update.call(this,this);this._draw.call(this,this);this._info.call(this,this);this._event.call(this,this);stats.end()},run:function(){this._begin.call(this,this);var a=this;if(this.intervalId=setInterval(function(){a._process.call(a)},1E3/this.fps))console.log("Stage, run()");else throw Error("Stage, can't run!");},stop:function(){try{clearInterval(this.intervalId),console.log("Stage, stop()")}catch(a){console.log(a)}},info:function(){this.finfo=!1==this.finfo?!0:
!1;console.log("Stage, info()");return null}}});
