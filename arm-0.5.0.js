var CSkeleton=Class({construct:function(a){if(isSet(a)){this.segments=TArray(a.segments);this.nativeSegments=a.segments;this.center=isTObject(a.center)?a.center:{x:this.nativeSegments[0].x0,y:this.nativeSegments[0].y0};this.nativeCenter=isTObject(a.center)?a.center:{x:this.nativeSegments[0].x0,y:this.nativeSegments[0].y0};for(var c in this._nativeSegments){var b=this._nativeSegments;if(0<=b[c].x0&&0<=b[c].y0&&0<=b[c].x1&&0<=b[c].y1){var a=b[c].x0,d=b[c].y0,e=b[c].x1,b=(b[c].y1-d)/(e-a),d=d-b*a,f=
{};f.k=b;f.b=d;f.x0=a;f.x1=e;this._functions.push(f)}}}else throw Error("CSkeleton: constructor(), Error");},vars:{segments:[],nativeSegments:[],center:{x:0,y:0},nativeCenter:{x:0,y:0},functions:[]},methods:{}});var CSuperObj=Class({construct:function(){},vars:{context:null,x:0,y:0},methods:{set x(a){this._x=TNumber(a)},get x(){return TNumber(this._x)},set y(a){this._y=TNumber(a)},get y(){return TNumber(this._y)},set context(a){this._context=a},get context(){return this._context},clone:function(){var a=[],c=function(b){if(null==b||"object"!=typeof b)return b;for(var d in a)if(a[d]==b)return b;a.push(b);if("function"==typeof b.constructor){d=new b.constructor;for(var e in b)if(b.hasOwnProperty(e))if("_context"==
e)d[e]=b[e];else{var f=b.__lookupGetter__(e),g=b.__lookupSetter__(e);f||g?(f&&d.prototype.__defineGetter__(e,f),g&&d.prototype.__defineSetter__(e,g)):d[e]=c(b[e])}}else return b;delete d.name;return d};return c(this)}}});var CObject=Class({base:CSuperObj,construct:function(a){if(isSet(a)){if(isTObject(a.vars))for(var c in a.vars)this[c]=a.vars[c];isTFunc(a.begin)&&(this.begin=a.begin);isTFunc(a.update)&&(this.update=a.update);this.collection={};if(isTArray(a.collection)&&1<=a.collection.length)for(var b in a.collection)("shape"==a.collection[b].type||"object"==a.collection[b].type)&&this.add(a.collection[b]);if(isSet(a.skeleton)&&isSet(a.skeleton.segments)&&isSet(a.skeleton.center))for(b in this._skeleton.segments=
a.skeleton.segments,this._skeleton._segments=a.skeleton.segments,this._skeleton.center=a.skeleton.center||{x:this.skeleton.segments[0].x0,y:sthis.skeleton.segments[0].y0},this._skeleton._center=this._skeleton.center,this._skeleton.functions=[],this._skeleton.segments){var d=this._skeleton.segments;if(0<=d[b].x0&&0<=d[b].y0&&0<=d[b].x1&&0<=d[b].y1){c=d[b].x0;var e=d[b].y0,f=d[b].x1,d=(d[b].y1-e)/(f-c),e=e-d*c,g={};g.k=d;g.b=e;g.x0=c;g.x1=f;this._skeleton.functions.push(g)}}if(isTObject(a.events))for(b in a.events)"function"==
typeof a.events[b]&&(this[b]=a.events[b])}},vars:{collection:{},skeleton:{},type:"object",count:-1},methods:{add:function(a){if(isTArmObject(a)||isTArmShape(a))a.context=this.context,isSet(a.name)?(this.count++,this.collection[this.count]=a,this[a.name]=a):(this.count++,this.collection[this.count]=a);else throw Error("Object: add() -> Incorrect object!");},remove:function(a){try{if(isTArmObject(a)||isTArmShape(a))for(var c in this.collection)this.collection[c]==a&&delete this.collection[c];else throw Error("Object: remove(O) -> O is not shape or object!");
}catch(b){console.log(b)}},set collection(a){if(isTObject(a)){this._collection=a;for(var c in a)if("shape"==a[c].type||"object"==a[c].type)this.add(a[c]);else throw Error("Object: set collection(O) -> O is not shape or object!");}else throw Error("Object: set collection(O) -> is not js'object!");},get collection(){return isTObject(this._collection)},set context(a){this._context=a;for(var c in this.collection)this.collection[c].context=a},get context(){return this._context},_begin:function(a){"function"==
typeof this.begin&&this.begin.call(this,a);for(var c in this.collection){var b=this.collection[c];"function"==typeof b.begin&&b!=this&&b.begin.call(b,a)}},_clean:function(a){var c=this.collection[b],b;for(b in this.collection)c._clean.call(c,a)},_updateSkeleton:function(a){var c=this.skeleton.segments,b=this.skeleton._segments,d=this.skeleton._center,e={segments:[]};e._segments=b;e.center=this.skeleton.center;e._center=d;e.functions=[];for(var f in c)c={},c.x0=b[f].x0+this.x,c.y0=b[f].y0+this.y,c.x1=
b[f].x1+this.x,c.y1=b[f].y1+this.y,e.segments.push(c),d={},d.k=(c.y1-c.y0)/(c.x1-c.x0),d.b=c.y0-d.k*c.x0,d.x0=c.x0,d.x1=c.x1,e.functions.push(d);e.center={x:e._center.x+this.x,y:e._center.y+this.y};this.skeleton=e;for(f in this.collection)b=this.collection[f],b._updateSkeleton&&b._updateSkeleton.call(b,a)},_update:function(a){isTFunc(this.update)&&this.update.call(this,a);for(var c in this.collection){var b=this.collection[c];b.update&&b.update.call(b,a)}},_draw:function(a){for(var c in this.collection){var b=
this.collection[c];b._draw.call(b,a)}},_info:function(a){var c=this.skeleton;a.context.beginPath();for(var b in c.segments)a.context.moveTo(c.segments[b].x0,c.segments[b].y0),a.context.lineTo(c.segments[b].x1,c.segments[b].y1),a.context.lineWidth=1,a.context.strokeStyle="#0f0";a.context.closePath();a.context.moveTo(c.center.x,c.center.y);a.context.arc(c.center.x,c.center.y,2,2*Math.PI,!1);this.context.stroke();this.context.fillStyle="#a00";this.context.fill();for(b in this.collection)a=this.collection[b],
"function"==typeof a._info&&a._info.call(a,this)},_event:function(a){this.__intersection.call(this,a);for(var c in this.collection)"function"==typeof this.collection[c]._event&&this.collection[c]._event.call(this.collection[c],a)},__intersection:function(a){var c=function(a,b){var c=a.x-a.lineWidth,d=a.x+a.width+a.lineWidth,e=a.y-a.lineWidth,f=a.y+a.height+a.lineWidth,g=b.x-b.lineWidth,i=b.x+b.width+b.lineWidth,h=b.y-b.lineWidth,k=b.y+b.height+b.lineWidth;if(g>=c&&i<=d||g>=c&&i>=d&&g<=d||g<=c&&i<=
d&&i>=c||g<=c&&i>=d)if(h>=e&&k<=f||h>=e&&k>=f&&h<=f||h<=e&&k<=f&&k>=e||h<=e&&k>=f)return!0;return!1},b=function(a,b){var c=a.y,d=a.radius,e=b.y,f=b.radius;return Math.sqrt(Math.pow(a.x-b.x,2)+Math.pow(c-e,2))<=d+f?!0:!1},d=function(a,e){for(var f in a.collection){var g=a.collection[f],h;for(h in e.collection){var j=e.collection[h];if(g!=j)return"rect"==g.shapeType&&"rect"==j.shapeType&&!1==i?c(g,j)||!1:"circle"==g.shapeType&&"circle"==j.shapeType&&!1==i?b(g,j)||!1:"object"==g.type&&"object"==j.type&&
!1==i?d(g,j)||!1:!1}}},e;for(e in this.collection){var f=this.collection[e],g;for(g in this.collection){var h=this.collection[g];if(h!=f){var i=!1;"rect"==f.shapeType&&("rect"==h.shapeType&&!1==i)&&(i=c(f,h)||!1);"circle"==f.shapeType&&("circle"==h.shapeType&&!1==i)&&(i=b(f,h)||!1);"object"==f.type&&("object"==h.type&&!1==i)&&(i=d(f,h)||!1);i&&"function"==typeof this.intersection&&this.intersection.call(this,f,h,a)}}}},_onkeydown:function(a,c){"function"==typeof this.onkeydown&&this.onkeydown.call(this,
a,c);for(var b in this.collection){var d=this.collection[b];"function"==typeof d._onkeydown&&(d=this.collection[b],d._onkeydown.call(d,a,c))}}}});CShape=Class({base:CSuperObj,construct:function(){},vars:{parent:"no",stroke:"black",lineWidth:1,angel:0,center:{x:0,y:0},shapeType:"shape",type:"shape"},methods:{}});var CRect=Class({base:CShape,construct:function(a){"undefined"!=typeof a&&(this.x=a.x||this.x,this.y=a.y||this.y,this.angel=a.angel||this.angel,this.stroke=a.stroke||this.stroke,this.fill=a.fill||this.fill,this.context=a.context||this.context,this.name=a.name||this.name,"undefined"!=typeof a.width&&0<a.width&&(this.width=a.width),"undefined"!=typeof a.height&&0<a.height&&(this.height=a.height),"undefined"!=typeof a.lineWidth&&0<a.lineWidth&&(this.lineWidth=a.lineWidth))},vars:{width:100,height:100,
fill:"gray",shapeType:"rect"},methods:{_clean:function(){},_draw:function(){this.context.save();this.context.translate(this.x+this.width/2,this.y+this.height/2);this.context.rotate(this.angel*Math.PI/180);this.context.translate(-(this.x+this.width/2),-(this.y+this.height/2));this.context.beginPath();this.context.rect(this.x,this.y,this.width,this.height);this.context.closePath();this.context.fillStyle=this.fill;this.context.lineWidth=this.lineWidth;this.context.strokeStyle=this.stroke;this.context.fill();
this.context.stroke();this.context.restore()}}});var CCircle=Class({base:CShape,construct:function(a){"undefined"!=typeof a&&("number"==typeof a.x&&(this.x=a.x),"number"==typeof a.y&&(this.y=a.y),"string"==typeof a.stroke&&(this.x=a.stroke),"string"==typeof a.fill&&(this.fill=a.fill),"undefined"!=typeof a.name&&(this.name=a.name),"undefined"!=typeof a.context&&(this.x=a.stroke),"undefined"!=typeof a.radius&&0<a.radius&&(this.radius=a.radius),"undefined"!=typeof a.lineWidth&&0<a.lineWidth&&(this.lineWidth=a.lineWidth))},vars:{radius:100,fill:"gray",
shapeType:"circle"},methods:{_clean:function(){this.context.clearRect(this.x-this.radius-this.lineWidth,this.y-this.radius-this.lineWidth,this.x+this.radius+this.lineWidth,this.y+this.radius+this.lineWidth)},_draw:function(){this.context.beginPath();this.context.arc(this.x,this.y,this.radius,0,2*Math.PI,!1);this.context.closePath();this.context.fillStyle=this.fill;this.context.fill();this.context.lineWidth=this.lineWidth;this.context.strokeStyle=this.stroke;this.context.stroke()}}});CImage=Class({base:CShape,construct:function(a){"undefined"!=typeof a&&(this.x=a.x||this.x,this.y=a.y||this.y,this.angel=a.angel||this.angel,this.center=a.center||this.center,this.stroke=a.stroke||this.stroke,this.image=a.image||this.image,this.context=a.context||this.context,this.name=a.name||this.name,"undefined"!=typeof a.width&&0<a.width&&(this.width=a.width),"undefined"!=typeof a.height&&0<a.height&&(this.height=a.height),"undefined"!=typeof a.lineWidth&&0<a.lineWidth&&(this.lineWidth=a.lineWidth))},
vars:{width:100,height:100,shapeType:"image"},methods:{_clean:function(){},_draw:function(){this.context.save();this.context.translate(this.center.x,this.center.y);this.context.rotate(this.angel*Math.PI/180);this.context.translate(-this.center.x,-this.center.y);this.context.drawImage(this.image,this.x,this.y,this.width,this.height);this.context.restore()}}});var CLine=Class({base:CShape,construct:function(a){"undefined"!=typeof a&&(this.x0=a.x0||this.x,this.y0=a.y0||this.y,this.x1=a.x1||this.x+100,this.y1=a.y1||this.y+100,this.stroke=a.stroke||this.stroke,this.context=a.context||this.context,this.name=a.name||this.name,"undefined"!=typeof a.lineWidth&&0<a.lineWidth&&(this.lineWidth=a.lineWidth))},vars:{x0:10,y0:10,x1:100,y1:100,shapeType:"line"},methods:{_clean:function(){},_draw:function(){this.context.beginPath();this.context.moveTo(this.x0,this.y0);
this.context.lineTo(this.x1,this.y1);this.context.closePath();this.context.lineWidth=this.lineWidth;this.context.strokeStyle=this.stroke;this.context.stroke()}}});var CStage=Class({construct:function(a){this.fps=a.fps||this.fps;this.width=a.width||this.width;this.height=a.height||this.height;if(a.container){var a=document.getElementById(a.container),c=document.createElement("canvas");c.width=this.width;c.height=this.height;c.style.id="2k2nd";a.appendChild(c);this.context=c.getContext("2d")}else throw Error("The container is not found! Choose right name of container, please!");this._init()},vars:{collection:[],context:{},events:{},fps:10,intervalId:null,finfo:!1,
width:500,height:500},methods:{add:function(a){if("object"==typeof a&&("shape"==a.type||"object"==a.type))a.context=this.context,this.collection.push(a);else throw Error("Stage: add(O) -> O is not shape or object!");},remove:function(a){if("object"==typeof a&&("shape"==a.type||"object"==a.type))for(var c in this.collection)this.collection[c]==a&&delete this.collection[c];else throw Error("Stage: remove(O) -> O is not shape or object!");},_init:function(){var a=this;document.onkeydown=function(c){a._onkeydown(c)}},
_begin:function(a){for(var c in this.collection){var b=this.collection[c];"function"==typeof b._begin&&b._begin.call(b,a)}},_clean:function(a){this.context.clearRect(0,0,a.width,a.height)},_updateSkeleton:function(a){for(var c in this.collection){var b=this.collection[c];"function"==typeof b._updateSkeleton&&b._updateSkeleton.call(b,a)}},_update:function(a){for(var c in this.collection){var b=this.collection[c];"function"==typeof b._update&&b._update.call(b,a)}},_draw:function(a){for(var c in this.collection){var b=
this.collection[c];"function"==typeof b._draw&&b._draw.call(b,a)}},_info:function(){if(!0==this.finfo)for(var a in this.collection){var c=this.collection[a];"function"==typeof c._info&&c._info.call(c,this)}},_event:function(a){for(var c in this.collection){var b=this.collection[c];"function"==typeof b._event&&b._event.call(b,a)}},_onkeydown:function(a){for(var c in this.collection){var b=this.collection[c];"function"==typeof b._onkeydown&&b._onkeydown.call(b,a,this)}},_process:function(){this._clean.call(this,
this);this._updateSkeleton.call(this,this);this._update.call(this,this);this._draw.call(this,this);this._info.call(this,this);this._event.call(this,this)},run:function(){this._begin.call(this,this);var a=this;if(this.intervalId=setInterval(function(){a._process.call(a)},1E3/this.fps))console.log("Stage, run()");else throw Error("Stage, can't run!");},stop:function(){try{clearInterval(this.intervalId),console.log("Stage, stop()")}catch(a){console.log(a)}},info:function(){this.finfo=!1==this.finfo?
!0:!1;console.log("Stage, info()");return null}}});
